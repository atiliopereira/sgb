<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ title }}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <style>
      .form-row {
        margin-bottom: 1rem;
      }
      .autocomplete-wrapper {
        position: relative;
      }
      .liquidacion-autocomplete {
        pointer-events: auto !important;
        user-select: text !important;
        -webkit-user-select: text !important;
        -moz-user-select: text !important;
        -ms-user-select: text !important;
        cursor: text !important;
        background-color: white !important;
      }
      .liquidacion-autocomplete:focus {
        border-color: #86b7fe !important;
        outline: 0 !important;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
      }
      .autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 0.25rem 0.25rem;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .autocomplete-item {
        padding: 0.5rem;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }
      .autocomplete-item:hover,
      .autocomplete-item.selected {
        background-color: #f8f9fa;
      }
      .autocomplete-item:last-child {
        border-bottom: none;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <h2>{{ title }}</h2>

      <form method="post" id="pago-form">
        {% csrf_token %}

        <div class="row">
          <div class="col-md-6">
            <div class="form-row">
              <label class="form-label">Liquidación (Número de Despacho):</label>
              <div class="autocomplete-wrapper">
                <input
                  type="text"
                  class="form-control liquidacion-autocomplete"
                  placeholder="Buscar por número de despacho o cliente..."
                  autocomplete="off"
                  value="{% if form.instance.liquidacion %}{{ form.instance.liquidacion.numero_despacho }} - {{ form.instance.liquidacion.cliente.nombre }}{% endif %}"
                  tabindex="1"
                />
                {{ form.liquidacion }}
                <div
                  class="liquidacion-autocomplete-results autocomplete-results"
                  style="display: none"
                ></div>
              </div>
            </div>
            <div class="form-row">
              <label for="{{ form.banco.id_for_label }}" class="form-label"
                >Banco:</label
              >
              {{ form.banco }}
            </div>
            <div class="form-row">
              <label for="{{ form.fecha.id_for_label }}" class="form-label"
                >Fecha:</label
              >
              {{ form.fecha }}
            </div>
          </div>

          <div class="col-md-6">
            <div class="form-row">
              <label for="{{ form.monto.id_for_label }}" class="form-label"
                >Monto:</label
              >
              {{ form.monto }}
            </div>
            <div class="form-row">
              <label for="{{ form.referencia.id_for_label }}" class="form-label"
                >Referencia:</label
              >
              {{ form.referencia }}
            </div>
            <div class="form-row">
              <label for="{{ form.concepto.id_for_label }}" class="form-label"
                >Concepto:</label
              >
              {{ form.concepto }}
            </div>
          </div>
        </div>

        <div class="mt-3">
          <button type="submit" class="btn btn-primary">
            {% if is_edit %}Actualizar{% else %}Guardar{% endif %} Pago
          </button>
          {% if is_edit %}
          <a
            href="{% url 'pago_detail' pago.pk %}"
            class="btn btn-secondary"
            >Cancelar</a
          >
          <a
            href="{% url 'pago_list' %}"
            class="btn btn-outline-secondary"
            >Volver a Lista</a
          >
          {% else %}
          <a href="{% url 'pago_list' %}" class="btn btn-secondary"
            >Cancelar</a
          >
          {% endif %}
        </div>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
          // Liquidacion Autocomplete functionality
          function initializeLiquidacionAutocomplete(wrapper) {
              console.log('=== initializeLiquidacionAutocomplete called ===');
              const input = wrapper.querySelector('.liquidacion-autocomplete');
              const hiddenInput = wrapper.querySelector('input[name="liquidacion"]');
              const resultsDiv = wrapper.querySelector('.liquidacion-autocomplete-results');
              let selectedIndex = -1;
              let searchTimeout;

              if (!input || !hiddenInput || !resultsDiv) {
                  console.log('❌ Missing liquidacion autocomplete elements');
                  return;
              }

              console.log('✅ Liquidacion autocomplete elements found');

              input.addEventListener('input', function() {
                  const query = this.value.trim();
                  selectedIndex = -1;

                  clearTimeout(searchTimeout);

                  if (query.length < 2) {
                      resultsDiv.style.display = 'none';
                      hiddenInput.value = '';
                      return;
                  }

                  searchTimeout = setTimeout(() => {
                      console.log('Fetching liquidacion autocomplete for query:', query);
                      fetch(`/liquidaciones/api/liquidacion-autocomplete/?q=${encodeURIComponent(query)}`)
                          .then(response => response.json())
                          .then(data => {
                              console.log('Liquidacion autocomplete data received:', data);
                              displayLiquidacionResults(data.results, resultsDiv, input, hiddenInput);
                          })
                          .catch(error => {
                              console.error('Error fetching liquidacion autocomplete:', error);
                              resultsDiv.style.display = 'none';
                          });
                  }, 300);
              });

              input.addEventListener('keydown', function(e) {
                  const items = resultsDiv.querySelectorAll('.autocomplete-item');

                  if (e.key === 'ArrowDown') {
                      e.preventDefault();
                      selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                      updateSelection(items, selectedIndex);
                  } else if (e.key === 'ArrowUp') {
                      e.preventDefault();
                      selectedIndex = Math.max(selectedIndex - 1, 0);
                      updateSelection(items, selectedIndex);
                  } else if (e.key === 'Enter') {
                      e.preventDefault();
                      if (selectedIndex >= 0 && items[selectedIndex]) {
                          selectLiquidacionItem(items[selectedIndex], input, hiddenInput, resultsDiv);
                      }
                  } else if (e.key === 'Escape') {
                      resultsDiv.style.display = 'none';
                      selectedIndex = -1;
                  }
              });

              // Close results when clicking outside
              document.addEventListener('click', function(e) {
                  if (!wrapper.contains(e.target)) {
                      resultsDiv.style.display = 'none';
                      selectedIndex = -1;
                  }
              });
          }

          function displayLiquidacionResults(results, resultsDiv, input, hiddenInput) {
              if (results.length === 0) {
                  resultsDiv.style.display = 'none';
                  return;
              }

              resultsDiv.innerHTML = '';
              results.forEach((liquidacion, index) => {
                  const div = document.createElement('div');
                  div.className = 'autocomplete-item';
                  div.textContent = liquidacion.text;
                  div.dataset.id = liquidacion.id;

                  div.addEventListener('click', () => {
                      selectLiquidacionItem(div, input, hiddenInput, resultsDiv);
                  });

                  resultsDiv.appendChild(div);
              });

              resultsDiv.style.display = 'block';
          }

          function updateSelection(items, selectedIndex) {
              items.forEach((item, index) => {
                  item.classList.toggle('selected', index === selectedIndex);
              });
          }

          function selectLiquidacionItem(item, input, hiddenInput, resultsDiv) {
              input.value = item.textContent;
              hiddenInput.value = item.dataset.id;
              resultsDiv.style.display = 'none';
          }

          // Initialize liquidacion autocomplete
          const liquidacionWrapper = document.querySelector('.autocomplete-wrapper');
          if (liquidacionWrapper) {
              initializeLiquidacionAutocomplete(liquidacionWrapper);
          }
          // Number formatting functions
          function formatNumber(num) {
              // Convert to integer and format with thousands separators
              const intValue = Math.round(parseFloat(num) || 0);
              return intValue.toLocaleString('es-PY'); // Paraguay locale for thousands separator
          }

          function unformatNumber(str) {
              // Remove thousands separators and convert to number
              if (!str) return 0;
              return parseFloat(str.toString().replace(/\./g, '') || '0');
          }

          function formatInput(input) {
              const cursorPos = input.selectionStart;
              const value = unformatNumber(input.value);
              const formatted = formatNumber(value);
              input.value = formatted;

              // Try to restore cursor position
              const newCursorPos = Math.min(cursorPos + (formatted.length - input.value.length), formatted.length);
              setTimeout(() => {
                  input.setSelectionRange(newCursorPos, newCursorPos);
              }, 0);
          }

          // Initialize number formatting for monto field
          const montoInput = document.querySelector('input[name="monto"]');
          if (montoInput) {
              // Format initial value if exists
              if (montoInput.value && montoInput.value !== '0') {
                  montoInput.value = formatNumber(montoInput.value);
              }

              // Add input event listener
              montoInput.addEventListener('input', function() {
                  formatInput(this);
              });

              // Format on blur
              montoInput.addEventListener('blur', function() {
                  formatInput(this);
              });
          }

          // Initialize date picker
          const dateInput = document.querySelector('input[name="fecha"]');
          if (dateInput) {
              flatpickr(dateInput, {
                  dateFormat: "d-m-Y",        // Display format: dd-mm-yyyy
                  altInput: true,             // Use alternate input for display
                  altFormat: "d-m-Y",         // Alternate display format
                  locale: "es",               // Spanish locale
                  allowInput: true,           // Allow manual input
                  clickOpens: true,           // Open on click
                  defaultDate: dateInput.value ? new Date(dateInput.value) : null,
                  onChange: function(selectedDates, dateStr, instance) {
                      // Convert to yyyy-mm-dd format for Django
                      if (selectedDates.length > 0) {
                          const date = selectedDates[0];
                          const year = date.getFullYear();
                          const month = String(date.getMonth() + 1).padStart(2, '0');
                          const day = String(date.getDate()).padStart(2, '0');
                          dateInput.value = `${year}-${month}-${day}`;
                      }
                  }
              });
          }

          // Handle form submission - convert formatted values back to decimal numbers
          document.getElementById('pago-form').addEventListener('submit', function(e) {
              console.log('=== PAGO FORM SUBMISSION STARTED ===');

              // Convert date format from DD-MM-YYYY to YYYY-MM-DD
              const fechaInput = document.querySelector('input[name="fecha"]');
              if (fechaInput && fechaInput.value) {
                  const originalDate = fechaInput.value;
                  // Check if it's in DD-MM-YYYY format (contains dashes and isn't YYYY-MM-DD)
                  if (originalDate.includes('-') && !originalDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                      const parts = originalDate.split('-');
                      if (parts.length === 3) {
                          // Convert DD-MM-YYYY to YYYY-MM-DD
                          const convertedDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                          fechaInput.value = convertedDate;
                          console.log(`Converted fecha: "${originalDate}" -> "${convertedDate}"`);
                      }
                  }
              }

              // Convert formatted monto field back to decimal value for Django
              if (montoInput && montoInput.value) {
                  const originalValue = montoInput.value;
                  const numericValue = unformatNumber(montoInput.value);
                  montoInput.value = numericValue.toString();
                  console.log(`Converted monto: "${originalValue}" -> "${numericValue}"`);
              }

              console.log('=== PAGO FORM VALUES CONVERTED, SUBMITTING TO DJANGO ===');
          });
      });
    </script>
  </body>
</html>